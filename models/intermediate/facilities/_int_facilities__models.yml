version: 2

models:
  - name: int_facilities_curated
    description: "Facilities curated from PM or fund admin sources with entity resolution and canonical enum mapping"
    columns:
      - name: facility_id
        description: "Canonical facility identifier resolved through xref_entities"
        tests:
          - unique
          - not_null
      - name: fund_id
        description: "Canonical fund identifier that owns the facility"
        tests:
          - not_null
          - relationships:
              to: ref('int_funds_unified')
              field: fund_id
      - name: borrower_company_id
        description: "Canonical company identifier for the borrower"
        tests:
          - not_null
          - relationships:
              to: ref('int_companies_unified')
              field: company_id
      - name: facility_type
        description: "Type of facility (TERM_LOAN_B, UNITRANCHE, REVOLVER, DELAYED_DRAWDOWN, MEZZANINE, RCF, BRIDGE)"
        tests:
          - not_null
          - accepted_values:
              values: ['TERM_LOAN_B', 'UNITRANCHE', 'REVOLVER', 'DELAYED_DRAWDOWN', 'MEZZANINE', 'RCF', 'BRIDGE']
      - name: agent_counterparty_id
        description: "Canonical counterparty identifier for the facility agent (optional)"
      - name: agreement_date
        description: "Date the facility agreement was signed"
        tests:
          - not_null
      - name: effective_date
        description: "Date the facility became effective (optional)"
      - name: maturity_date
        description: "Date the facility matures (optional)"
      - name: currency_code
        description: "Currency code for the facility"
        tests:
          - not_null
      - name: total_commitment
        description: "Total commitment amount for the facility"
      - name: purpose
        description: "Purpose of the facility"
      - name: created_at
        description: "Timestamp when the record was created"
      - name: updated_at
        description: "Timestamp when the record was last updated"

  - name: int_loans_curated
    description: "Loans curated from PM or fund admin sources, linked to facilities and instruments with canonical enum mapping"
    columns:
      - name: loan_id
        description: "Canonical loan identifier resolved through xref_entities"
        tests:
          - unique
          - not_null
      - name: instrument_id
        description: "Canonical instrument identifier (one-to-one with loan)"
        tests:
          - unique
          - not_null
          - relationships:
              to: ref('int_instruments_unified')
              field: instrument_id
      - name: facility_id
        description: "Canonical facility identifier that the loan belongs to"
        tests:
          - not_null
          - relationships:
              to: ref('int_facilities_curated')
              field: facility_id
      - name: loan_type
        description: "Type of loan (TERM, REVOLVER, DDTL, BRIDGE, MEZZ)"
        tests:
          - not_null
          - accepted_values:
              values: ['TERM', 'REVOLVER', 'DDTL', 'BRIDGE', 'MEZZ']
      - name: tranche_label
        description: "Tranche label within the facility (optional)"
      - name: commitment_amount
        description: "Commitment amount for the loan"
      - name: currency_code
        description: "Currency code for the loan"
        tests:
          - not_null
      - name: start_date
        description: "Start date of the loan"
        tests:
          - not_null
      - name: maturity_date
        description: "Maturity date of the loan"
        tests:
          - not_null
      - name: interest_index
        description: "Interest rate index (SOFR, EURIBOR, SONIA, FED_FUNDS, FIXED)"
        tests:
          - not_null
          - accepted_values:
              values: ['SOFR', 'EURIBOR', 'SONIA', 'FED_FUNDS', 'FIXED']
      - name: index_tenor_days
        description: "Tenor of the interest rate index in days (optional)"
      - name: fixed_rate_pct
        description: "Fixed interest rate percentage (optional)"
      - name: spread_bps
        description: "Spread over index in basis points"
        tests:
          - not_null
      - name: floor_pct
        description: "Interest rate floor percentage (optional)"
      - name: day_count
        description: "Day count convention (30E_360, ACT_360, ACT_365, ACT_ACT)"
        tests:
          - not_null
          - accepted_values:
              values: ['30E_360', 'ACT_360', 'ACT_365', 'ACT_ACT']
      - name: pay_freq_months
        description: "Payment frequency in months"
        tests:
          - not_null
      - name: amortization_type
        description: "Amortization type (BULLET, STRAIGHT_LINE, CUSTOM_SCHEDULE)"
        tests:
          - not_null
          - accepted_values:
              values: ['BULLET', 'STRAIGHT_LINE', 'CUSTOM_SCHEDULE']
      - name: security_rank
        description: "Security rank (SENIOR_SECURED, SENIOR_UNSECURED, SECOND_LIEN, MEZZANINE, PIK) (optional)"
        tests:
          - accepted_values:
              values: ['SENIOR_SECURED', 'SENIOR_UNSECURED', 'SECOND_LIEN', 'MEZZANINE', 'PIK']
      - name: status
        description: "Current status of the loan (optional)"
      - name: created_at
        description: "Timestamp when the record was created"
      - name: updated_at
        description: "Timestamp when the record was last updated"

  - name: int_facility_lenders_curated
    description: "Facility syndicate participants curated from PM or fund admin sources with XOR constraint on counterparty_id/fund_id"
    columns:
      - name: facility_id
        description: "Canonical facility identifier"
        tests:
          - not_null
          - relationships:
              to: ref('int_facilities_curated')
              field: facility_id
      - name: counterparty_id
        description: "Canonical counterparty identifier (XOR with fund_id)"
      - name: fund_id
        description: "Canonical fund identifier (XOR with counterparty_id)"
      - name: syndicate_role
        description: "Role in the syndicate (AGENT, ARRANGER, LENDER, CO_LENDER, ADMIN_AGENT) (optional)"
        tests:
          - accepted_values:
              values: ['AGENT', 'ARRANGER', 'LENDER', 'CO_LENDER', 'ADMIN_AGENT']
      - name: commitment_amount
        description: "Commitment amount from this lender"
      - name: allocation_pct
        description: "Allocation percentage for this lender"
      - name: primary_flag
        description: "Flag indicating if this is the primary lender"
      - name: created_at
        description: "Timestamp when the record was created"
      - name: updated_at
        description: "Timestamp when the record was last updated"
