version: 2

sources:
  - name: pm
    description: "Portfolio Management system source data for investments, valuations, and company financials"
    database: "{{ env_var('DBT_RAW_DATABASE', 'RAW') }}"
    schema: "{{ target.schema }}_AMOS_PM_EXAMPLE"
    meta:
      system_name: "Portfolio Management Vendor"
    
    tables:
      - name: pm_company_financials
        description: "Company financial statements from Portfolio Management system"
        meta:
          add_metadata: true
          column_transformations:
            id: "trim(id)"
            company_id: "trim(company_id)"
            period: "trim(period)"
            accounts_type: "trim(accounts_type)"
            currency_code: "upper(trim(currency_code))"
        columns:
          - name: id
            description: "Unique financial record identifier"
          - name: company_id
            description: "Company identifier"
          - name: end_date
            description: "Period end date"
          - name: start_date
            description: "Period start date"
          - name: period
            description: "Period type (ANNUAL, QUARTERLY)"
          - name: accounts_type
            description: "Accounts type (AUDITED, MANAGEMENT)"
          - name: currency_code
            description: "Currency code"
          - name: revenue
            description: "Revenue"
          - name: cost_of_goods_sold
            description: "Cost of goods sold"
          - name: gross_profit
            description: "Gross profit"
          - name: operating_expenses
            description: "Operating expenses"
          - name: ebitda
            description: "EBITDA"
          - name: depreciation_amortization
            description: "Depreciation and amortization"
          - name: ebit
            description: "EBIT"
          - name: net_income
            description: "Net income"
          - name: cash
            description: "Cash balance"
          - name: total_assets
            description: "Total assets"
          - name: total_liabilities
            description: "Total liabilities"
          - name: equity
            description: "Equity"
          - name: operating_cash_flow
            description: "Operating cash flow"
          - name: investing_cash_flow
            description: "Investing cash flow"
          - name: financing_cash_flow
            description: "Financing cash flow"
          - name: created_at
            description: "Record creation timestamp"
          - name: updated_at
            description: "Last update timestamp"
      
      - name: pm_facilities
        description: "Credit facility details from Portfolio Management system"
        meta:
          add_metadata: true
          column_transformations:
            facility_id: "trim(facility_id)"
            facility_name: "trim(facility_name)"
            borrower_company_id: "trim(borrower_company_id)"
            facility_type: "trim(upper(facility_type))"
            currency_code: "upper(trim(currency_code))"
            status: "trim(upper(status))"
        columns:
          - name: facility_id
            description: "Unique facility identifier"
          - name: facility_name
            description: "Facility name"
          - name: borrower_company_id
            description: "Borrower company identifier"
          - name: facility_type
            description: "Facility type"
          - name: total_commitment
            description: "Total facility commitment"
          - name: currency_code
            description: "Currency code"
          - name: start_date
            description: "Facility start date"
          - name: maturity_date
            description: "Facility maturity date"
          - name: status
            description: "Facility status"
          - name: created_date
            description: "Record creation date"
          - name: last_modified_date
            description: "Last modification date"

      
      - name: pm_instruments
        description: "Unified instrument master data from Portfolio Management system with type-specific columns"
        meta:
          add_metadata: true
          column_transformations:
            pm_instrument_id: "trim(pm_instrument_id)"
            pm_fund_id: "trim(pm_fund_id)"
            pm_company_id: "trim(pm_company_id)"
            instrument_name: "trim(instrument_name)"
            instrument_type: "upper(trim(instrument_type))"
            share_class_name: "trim(share_class_name)"
            currency_code: "upper(trim(currency_code))"
            fx_rate_source: "trim(fx_rate_source)"
            pm_facility_id: "trim(pm_facility_id)"
            tranche_label: "trim(tranche_label)"
            interest_index: "upper(trim(interest_index))"
            day_count: "upper(trim(day_count))"
            amortization_type: "upper(trim(amortization_type))"
            security_rank: "upper(trim(security_rank))"
        columns:
          - name: pm_instrument_id
            description: "Unique instrument identifier from PM system"
          - name: pm_fund_id
            description: "Fund identifier from PM system"
          - name: pm_company_id
            description: "Company identifier from PM system"
          - name: instrument_name
            description: "Instrument name"
          - name: instrument_type
            description: "Instrument type (EQUITY, LOAN)"
          - name: inception_date
            description: "Instrument inception date"
          - name: termination_date
            description: "Instrument termination date"
          - name: share_class_name
            description: "Share class name (equity only)"
          - name: initial_share_count
            description: "Initial share count (equity only)"
          - name: initial_ownership_pct
            description: "Initial ownership percentage (equity only)"
          - name: initial_cost
            description: "Initial cost (equity only)"
          - name: initial_price_per_share
            description: "Initial price per share (equity only)"
          - name: currency_code
            description: "Currency code"
          - name: fx_rate
            description: "FX rate for currency conversion"
          - name: fx_rate_as_of
            description: "FX rate as of date"
          - name: fx_rate_source
            description: "FX rate source"
          - name: pm_facility_id
            description: "Facility identifier from PM system (credit only)"
          - name: tranche_label
            description: "Tranche label (credit only)"
          - name: commitment_amount
            description: "Commitment amount (credit only)"
          - name: start_date
            description: "Start date (credit only)"
          - name: maturity_date
            description: "Maturity date (credit only)"
          - name: interest_index
            description: "Interest rate index (credit only)"
          - name: spread_bps
            description: "Spread in basis points (credit only)"
          - name: floor_pct
            description: "Interest rate floor percentage (credit only)"
          - name: day_count
            description: "Day count convention (credit only)"
          - name: pay_freq_months
            description: "Payment frequency in months (credit only)"
          - name: amortization_type
            description: "Amortization type (credit only)"
          - name: security_rank
            description: "Security rank (credit only)"
      
      - name: pm_instrument_snapshots
        description: "Periodic instrument valuations and positions from Portfolio Management system"
        meta:
          add_metadata: true
          column_transformations:
            pm_instrument_snapshot_id: "trim(pm_instrument_snapshot_id)"
            pm_instrument_id: "trim(pm_instrument_id)"
            frequency: "upper(trim(frequency))"
            reporting_basis: "upper(trim(reporting_basis))"
            snapshot_source: "upper(trim(snapshot_source))"
            currency_code: "upper(trim(currency_code))"
            fx_rate_source: "trim(fx_rate_source)"
            stake_basis: "trim(stake_basis)"
            status: "trim(status)"
            snapshot_source_file_ref: "trim(snapshot_source_file_ref)"
        columns:
          - name: pm_instrument_snapshot_id
            description: "Unique snapshot identifier"
          - name: pm_instrument_id
            description: "Instrument identifier from PM system"
          - name: period_start_date
            description: "Period start date"
          - name: period_end_date
            description: "Period end date"
          - name: frequency
            description: "Snapshot frequency"
          - name: reporting_basis
            description: "Reporting basis"
          - name: snapshot_source
            description: "Snapshot source"
          - name: currency_code
            description: "Currency code"
          - name: fx_rate
            description: "FX rate for currency conversion"
          - name: fx_rate_as_of
            description: "FX rate as of date"
          - name: fx_rate_source
            description: "FX rate source"
          - name: fair_value
            description: "Fair value"
          - name: accrued_income
            description: "Accrued income"
          - name: equity_stake_pct
            description: "Equity stake percentage (equity only)"
          - name: stake_basis
            description: "Stake basis (equity only)"
          - name: principal_outstanding
            description: "Principal outstanding (credit only)"
          - name: undrawn_commitment
            description: "Undrawn commitment (credit only)"
          - name: accrued_interest
            description: "Accrued interest (credit only)"
          - name: accrued_fees
            description: "Accrued fees (credit only)"
          - name: amortized_cost
            description: "Amortized cost (credit only)"
          - name: expected_loss
            description: "Expected loss (credit only)"
          - name: status
            description: "Status (credit only)"
          - name: snapshot_source_file_ref
            description: "Source file reference for traceability"
      
      - name: pm_instrument_cashflows
        description: "Instrument cashflow transactions from Portfolio Management system"
        meta:
          add_metadata: true
          column_transformations:
            pm_instrument_cashflow_id: "trim(pm_instrument_cashflow_id)"
            pm_instrument_id: "trim(pm_instrument_id)"
            instrument_cashflow_type: "upper(trim(instrument_cashflow_type))"
            currency_code: "upper(trim(currency_code))"
            fx_rate_source: "trim(fx_rate_source)"
            pm_transaction_id: "trim(pm_transaction_id)"
            reference: "trim(reference)"
        columns:
          - name: pm_instrument_cashflow_id
            description: "Unique cashflow identifier"
          - name: pm_instrument_id
            description: "Instrument identifier from PM system"
          - name: instrument_cashflow_type
            description: "Cashflow type"
          - name: date
            description: "Cashflow date"
          - name: currency_code
            description: "Currency code"
          - name: fx_rate
            description: "FX rate for currency conversion"
          - name: fx_rate_as_of
            description: "FX rate as of date"
          - name: fx_rate_source
            description: "FX rate source"
          - name: amount
            description: "Cashflow amount"
          - name: pm_transaction_id
            description: "Transaction identifier from PM system"
          - name: reference
            description: "Cashflow reference"
          - name: non_cash
            description: "Non-cash transaction flag"
      
      - name: pm_instrument_countries
        description: "Instrument to country allocations from Portfolio Management system"
        meta:
          add_metadata: true
          column_transformations:
            pm_instrument_id: "trim(pm_instrument_id)"
            country_code: "upper(trim(country_code))"
            role: "trim(role)"
        columns:
          - name: pm_instrument_id
            description: "Instrument identifier from PM system"
          - name: country_code
            description: "ISO country code"
          - name: primary_flag
            description: "Primary country flag"
          - name: allocation_pct
            description: "Allocation percentage"
          - name: role
            description: "Country role"
      
      - name: pm_instrument_industries
        description: "Instrument to industry classifications from Portfolio Management system"
        meta:
          add_metadata: true
          column_transformations:
            pm_instrument_id: "trim(pm_instrument_id)"
            pm_industry_id: "trim(pm_industry_id)"
        columns:
          - name: pm_instrument_id
            description: "Instrument identifier from PM system"
          - name: pm_industry_id
            description: "Industry identifier from PM system"
          - name: primary_flag
            description: "Primary industry flag"

      - name: pm_valuations
        description: "Company-level equity valuations from Portfolio Management system"
        meta:
          add_metadata: true
          column_transformations:
            valuation_id: "trim(valuation_id)"
            company_id: "trim(company_id)"
        columns:
          - name: valuation_id
            description: "Unique valuation record identifier"
          - name: company_id
            description: "PM company identifier"
          - name: valuation_date
            description: "Valuation date"
          - name: equity_value
            description: "Equity valuation amount"
          - name: created_date
            description: "Record creation date"
          - name: last_modified_date
            description: "Last modification date"
