version: 2

sources:
  - name: pm
    description: "Portfolio Management system source data for investments, valuations, and company financials"
    database: "{{ env_var('DBT_RAW_DATABASE', 'RAW') }}"
    schema: "{{ target.schema }}_AMOS_PM_EXAMPLE"
    meta:
      system_name: "Portfolio Management Vendor"
    
    tables:
      - name: pm_investment_rounds
        description: "Investment rounds detail from Portfolio Management system - consolidated table with both instrument metadata and round-level transactions"
        meta:
          add_metadata: true
          column_transformations:
            round_id: "trim(round_id)"
            investment_code: "trim(investment_code)"
            investment_name: "trim(investment_name)"
            company_id: "trim(company_id)"
            company_name: "trim(upper(company_name))"
            fund_id: "trim(fund_id)"
            fund_name: "trim(fund_name)"
            round_name: "trim(round_name)"
            round_currency: "upper(trim(round_currency))"
            share_class: "trim(share_class)"
            round_description: "trim(round_description)"
            investment_type: "trim(investment_type)"
            investment_stage: "trim(investment_stage)"
            sector: "trim(sector)"
            geography: "trim(geography)"
            liquidation_preference: "trim(liquidation_preference)"
            anti_dilution_protection: "trim(anti_dilution_protection)"
            drag_along_rights: "trim(drag_along_rights)"
            tag_along_rights: "trim(tag_along_rights)"
            investment_thesis: "trim(investment_thesis)"
            key_risks: "trim(key_risks)"
            exit_strategy: "trim(exit_strategy)"
        columns:
          - name: round_id
            description: "Unique round identifier from PM system"
          - name: investment_code
            description: "Investment identifier (groups multiple rounds)"
          - name: investment_name
            description: "Investment name"
          - name: company_id
            description: "Company identifier"
          - name: company_name
            description: "Company name"
          - name: fund_id
            description: "Fund identifier"
          - name: fund_name
            description: "Fund name"
          - name: round_name
            description: "Round name (e.g., Series A, Series B, Follow-on)"
          - name: round_date
            description: "Date of the investment round"
          - name: round_amount
            description: "Amount invested in this round"
          - name: round_currency
            description: "Currency code for round amount"
          - name: stake_acquired
            description: "Percentage stake acquired in this round"
          - name: share_class
            description: "Share class for this round"
          - name: number_of_shares
            description: "Number of shares acquired in this round"
          - name: round_description
            description: "Description of the investment round"
          - name: investment_type
            description: "Type of investment (Equity, Loan, etc.)"
          - name: investment_stage
            description: "Investment stage (Growth, Buyout, etc.)"
          - name: sector
            description: "Sector classification"
          - name: geography
            description: "Geographic region"
          - name: board_seats
            description: "Number of board seats"
          - name: liquidation_preference
            description: "Liquidation preference terms"
          - name: anti_dilution_protection
            description: "Anti-dilution protection terms"
          - name: drag_along_rights
            description: "Drag-along rights indicator"
          - name: tag_along_rights
            description: "Tag-along rights indicator"
          - name: investment_thesis
            description: "Investment thesis"
          - name: key_risks
            description: "Key risk factors"
          - name: exit_strategy
            description: "Exit strategy"
          - name: target_exit_date
            description: "Target exit date"
          - name: created_date
            description: "Record creation date"
          - name: last_modified_date
            description: "Last modification date"
      
      - name: pm_valuations
        description: "Company valuations from Portfolio Management system"
        meta:
          add_metadata: true
          column_transformations:
            valuation_id: "trim(valuation_id)"
            company_id: "trim(company_id)"
            company_name: "trim(upper(company_name))"
            investment_id: "trim(investment_id)"
            valuation_method: "trim(valuation_method)"
            enterprise_value_currency: "upper(trim(enterprise_value_currency))"
            equity_value_currency: "upper(trim(equity_value_currency))"
            book_multiple: "trim(book_multiple)"
            comparable_companies: "trim(comparable_companies)"
            discount_rate: "trim(discount_rate)"
            terminal_growth_rate: "trim(terminal_growth_rate)"
            valuation_notes: "trim(valuation_notes)"
            valuation_source: "trim(valuation_source)"
            confidence_level: "trim(confidence_level)"
        columns:
          - name: valuation_id
            description: "Unique valuation identifier"
          - name: company_id
            description: "Company identifier"
          - name: company_name
            description: "Company name"
          - name: investment_id
            description: "Investment identifier"
          - name: valuation_date
            description: "Valuation date"
          - name: valuation_method
            description: "Valuation methodology"
          - name: enterprise_value
            description: "Enterprise value"
          - name: enterprise_value_currency
            description: "Currency code for enterprise value"
          - name: equity_value
            description: "Equity value"
          - name: equity_value_currency
            description: "Currency code for equity value"
          - name: revenue_multiple
            description: "Revenue multiple"
          - name: ebitda_multiple
            description: "EBITDA multiple"
          - name: book_multiple
            description: "Book value multiple"
          - name: comparable_companies
            description: "Comparable companies used"
          - name: discount_rate
            description: "Discount rate used"
          - name: terminal_growth_rate
            description: "Terminal growth rate"
          - name: valuation_notes
            description: "Valuation notes"
          - name: valuation_source
            description: "Source of valuation"
          - name: confidence_level
            description: "Confidence level in valuation"
          - name: last_financing_round_valuation
            description: "Last financing round valuation"
          - name: last_financing_date
            description: "Last financing date"
          - name: created_date
            description: "Record creation date"
          - name: last_modified_date
            description: "Last modification date"
      
      - name: pm_company_financials
        description: "Company financial statements from Portfolio Management system"
        meta:
          add_metadata: true
          column_transformations:
            id: "trim(id)"
            company_id: "trim(company_id)"
            period: "trim(period)"
            accounts_type: "trim(accounts_type)"
            currency_code: "upper(trim(currency_code))"
        columns:
          - name: id
            description: "Unique financial record identifier"
          - name: company_id
            description: "Company identifier"
          - name: end_date
            description: "Period end date"
          - name: start_date
            description: "Period start date"
          - name: period
            description: "Period type (ANNUAL, QUARTERLY)"
          - name: accounts_type
            description: "Accounts type (AUDITED, MANAGEMENT)"
          - name: currency_code
            description: "Currency code"
          - name: revenue
            description: "Revenue"
          - name: cost_of_goods_sold
            description: "Cost of goods sold"
          - name: gross_profit
            description: "Gross profit"
          - name: operating_expenses
            description: "Operating expenses"
          - name: ebitda
            description: "EBITDA"
          - name: depreciation_amortization
            description: "Depreciation and amortization"
          - name: ebit
            description: "EBIT"
          - name: net_income
            description: "Net income"
          - name: cash
            description: "Cash balance"
          - name: total_assets
            description: "Total assets"
          - name: total_liabilities
            description: "Total liabilities"
          - name: equity
            description: "Equity"
          - name: operating_cash_flow
            description: "Operating cash flow"
          - name: investing_cash_flow
            description: "Investing cash flow"
          - name: financing_cash_flow
            description: "Financing cash flow"
          - name: created_at
            description: "Record creation timestamp"
          - name: updated_at
            description: "Last update timestamp"
      
      - name: pm_investment_countries
        description: "Investment to country allocations from Portfolio Management system"
        meta:
          add_metadata: true
          column_transformations:
            investment_id: "trim(investment_id)"
            country_code: "upper(trim(country_code))"
        columns:
          - name: investment_id
            description: "Investment identifier"
          - name: country_code
            description: "ISO country code"
          - name: percentage
            description: "Allocation percentage"
      


      - name: pm_loans
        description: "Loan details from Portfolio Management system"
        meta:
          add_metadata: true
          column_transformations:
            loan_id: "trim(loan_id)"
            instrument_id: "trim(instrument_id)"
            facility_id: "trim(facility_id)"
            borrower_company_id: "trim(borrower_company_id)"
            loan_type: "trim(upper(loan_type))"
            tranche_label: "trim(tranche_label)"
            currency_code: "upper(trim(currency_code))"
            interest_index: "trim(upper(interest_index))"
            day_count: "trim(upper(day_count))"
            amortization_type: "trim(upper(amortization_type))"
            security_rank: "trim(upper(security_rank))"
            status: "trim(upper(status))"
        columns:
          - name: loan_id
            description: "Unique loan identifier"
          - name: instrument_id
            description: "Instrument identifier"
          - name: facility_id
            description: "Facility identifier"
          - name: borrower_company_id
            description: "Borrower company identifier"
          - name: loan_type
            description: "Loan type (TERM, REVOLVER, MEZZ, etc.)"
          - name: tranche_label
            description: "Tranche label"
          - name: commitment_amount
            description: "Total loan commitment amount"
          - name: currency_code
            description: "Currency code"
          - name: start_date
            description: "Loan start date"
          - name: maturity_date
            description: "Loan maturity date"
          - name: interest_index
            description: "Interest rate index (SOFR, EURIBOR, etc.)"
          - name: index_tenor_days
            description: "Index tenor in days"
          - name: fixed_rate_pct
            description: "Fixed interest rate percentage"
          - name: spread_bps
            description: "Spread over index in basis points"
          - name: floor_pct
            description: "Interest rate floor percentage"
          - name: day_count
            description: "Day count convention"
          - name: pay_freq_months
            description: "Payment frequency in months"
          - name: amortization_type
            description: "Amortization type (BULLET, STRAIGHT_LINE, etc.)"
          - name: security_rank
            description: "Security rank (SENIOR_SECURED, MEZZANINE, etc.)"
          - name: status
            description: "Loan status"
          - name: created_date
            description: "Record creation date"
          - name: last_modified_date
            description: "Last modification date"
      
      - name: pm_facilities
        description: "Credit facility details from Portfolio Management system"
        meta:
          add_metadata: true
          column_transformations:
            facility_id: "trim(facility_id)"
            facility_name: "trim(facility_name)"
            borrower_company_id: "trim(borrower_company_id)"
            facility_type: "trim(upper(facility_type))"
            currency_code: "upper(trim(currency_code))"
            status: "trim(upper(status))"
        columns:
          - name: facility_id
            description: "Unique facility identifier"
          - name: facility_name
            description: "Facility name"
          - name: borrower_company_id
            description: "Borrower company identifier"
          - name: facility_type
            description: "Facility type"
          - name: total_commitment
            description: "Total facility commitment"
          - name: currency_code
            description: "Currency code"
          - name: start_date
            description: "Facility start date"
          - name: maturity_date
            description: "Facility maturity date"
          - name: status
            description: "Facility status"
          - name: created_date
            description: "Record creation date"
          - name: last_modified_date
            description: "Last modification date"
      
      - name: pm_loan_cashflows
        description: "Loan cashflow transactions from Portfolio Management system"
        meta:
          add_metadata: true
          column_transformations:
            loan_cashflow_id: "trim(loan_cashflow_id)"
            loan_id: "trim(loan_id)"
            cashflow_type: "trim(upper(cashflow_type))"
            currency_code: "upper(trim(currency_code))"
            description: "trim(description)"
        columns:
          - name: loan_cashflow_id
            description: "Unique cashflow identifier"
          - name: loan_id
            description: "Loan identifier"
          - name: cashflow_type
            description: "Cashflow type (DRAW, PRINCIPAL_REPAYMENT, INTEREST_PAYMENT, etc.)"
          - name: cashflow_date
            description: "Cashflow date"
          - name: amount
            description: "Cashflow amount"
          - name: currency_code
            description: "Currency code"
          - name: description
            description: "Cashflow description"
          - name: created_date
            description: "Record creation date"
          - name: last_modified_date
            description: "Last modification date"
      
      - name: pm_loan_snapshots
        description: "Loan position snapshots from Portfolio Management system"
        meta:
          add_metadata: true
          column_transformations:
            loan_snapshot_id: "trim(loan_snapshot_id)"
            loan_id: "trim(loan_id)"
            status: "trim(upper(status))"
            currency_code: "upper(trim(currency_code))"
        columns:
          - name: loan_snapshot_id
            description: "Unique snapshot identifier"
          - name: loan_id
            description: "Loan identifier"
          - name: period_end_date
            description: "Period end date"
          - name: principal_outstanding
            description: "Principal outstanding"
          - name: undrawn_commitment
            description: "Undrawn commitment"
          - name: accrued_interest
            description: "Accrued interest"
          - name: fair_value
            description: "Fair value"
          - name: status
            description: "Loan status"
          - name: currency_code
            description: "Currency code"
          - name: created_date
            description: "Record creation date"
          - name: last_modified_date
            description: "Last modification date"
